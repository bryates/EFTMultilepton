#ifndef _RecoIDIsoSIPSFs_h
#define _RecoIDIsoSIPSFs_h

class RecoIDIsoSIPSFs: public KinematicVariable<double> {

public:
  RecoIDIsoSIPSFs(int numLeps, BNleptonCollection **_tightLoosePreselectedLeptons, string _option="none");
  ~RecoIDIsoSIPSFs();
  void evaluate();
  double fetch(BNlepton* lepton, TH2D* histo);
  double fetchError(BNlepton* lepton, TH2D* histo);

  int numLeps;
  BNleptonCollection **tightLoosePreselectedLeptons;
  TFile electronFile;
  TFile muonFile;
  TH2D* electronSFHisto;
  TH2D* muonSFHisto;
  string option;
  int xBin;
  int yBin;
  TString branchName;
  TString branchNameUp;
  TString branchNameDown;
};

RecoIDIsoSIPSFs::RecoIDIsoSIPSFs(int _numLeps, BNleptonCollection **_tightLoosePreselectedLeptons, string _option):
  numLeps(_numLeps),
  tightLoosePreselectedLeptons(_tightLoosePreselectedLeptons),
  electronFile((string(getenv("CMSSW_BASE"))+"/src/EFTMultilepton/TemplateMakers/data/CERN/eff_ele12.root").c_str()),
  muonFile((string(getenv("CMSSW_BASE"))+"/src/EFTMultilepton/TemplateMakers/data/CERN/eff_mu12.root").c_str()),
  option(_option)
{
  this->resetVal = KinematicVariableConstants::DOUBLE_INIT;

  electronSFHisto = (TH2D*)electronFile.Get("h_electron_scale_factor_RECO_ID_ISO_SIP")->Clone();
  muonSFHisto = (TH2D*)muonFile.Get("TH2D_ALL_2012")->Clone();

  branchName = Form("RecoIDIsoSIPSF_%dlep", numLeps);
  branchNameUp = Form("RecoIDIsoSIPSFUp_%dlep", numLeps);
  branchNameDown = Form("RecoIDIsoSIPSFDown_%dlep", numLeps);
  branches[branchName] = BranchInfo<double>(branchName);
  if (option != "skipSyst") {
    branches[branchNameUp] = BranchInfo<double>(branchNameUp);
    branches[branchNameDown] = BranchInfo<double>(branchNameDown);
  }
}

void RecoIDIsoSIPSFs::evaluate() {
  if (this->evaluatedThisEvent) return;
  evaluatedThisEvent = true;

  double SF = 1.0;
  double SFUp = 1.0;
  double SFDown = 1.0;
  double totalSF = 1.0;
  double totalSFUp = 1.0;
  double totalSFDown = 1.0;

  BNleptonCollection * leptons = *tightLoosePreselectedLeptons;

  numLeps = std::min(numLeps, int(leptons->size()));
  for (int i=0; i<numLeps; i++) {
    if (leptons->at(i)->isMuon) {
      SF = fetch(leptons->at(i), muonSFHisto);
      SFUp = SF + fetchError(leptons->at(i), muonSFHisto);
      SFDown = SF - fetchError(leptons->at(i), muonSFHisto);
    } else {
      SF = fetch(leptons->at(i), electronSFHisto);
      SFUp = SF + fetchError(leptons->at(i), electronSFHisto);
      SFDown = SF - fetchError(leptons->at(i), electronSFHisto);
    }

    totalSF *= SF;
    totalSFUp *= SFUp;
    totalSFDown *= SFDown;
  }

  branches[branchName].branchVal = totalSF;
  if (option != "skipSyst") {
    branches[branchNameUp].branchVal = totalSFUp;
    branches[branchNameDown].branchVal = totalSFDown;
  }
}

double RecoIDIsoSIPSFs::fetch(BNlepton* lepton, TH2D* histo) {
  double SF = 1.0;

  xBin = std::min(histo->GetXaxis()->FindBin(lepton->pt), histo->GetXaxis()->GetNbins());
  yBin = std::min(histo->GetYaxis()->FindBin(abs(lepton->eta)), histo->GetYaxis()->GetNbins());

  SF = histo->GetBinContent(xBin, yBin);

  return SF;
}

double RecoIDIsoSIPSFs::fetchError(BNlepton* lepton, TH2D* histo) {
  double SF = 1.0;

  xBin = std::min(histo->GetXaxis()->FindBin(lepton->pt), histo->GetXaxis()->GetNbins());
  yBin = std::min(histo->GetYaxis()->FindBin(abs(lepton->eta)), histo->GetYaxis()->GetNbins());

  SF = histo->GetBinError(xBin, yBin);

  return SF;
}

RecoIDIsoSIPSFs::~RecoIDIsoSIPSFs() {
  delete electronSFHisto;
  delete muonSFHisto;

  electronFile.Close();
  muonFile.Close();
 }

#endif
